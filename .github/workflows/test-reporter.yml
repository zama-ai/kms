name: test-reporter

on:
  workflow_call:
    secrets:
      BLOCKCHAIN_ACTIONS_TOKEN:
        required: true
    # Security: This workflow only runs when called from other workflows in the same repository
    # and uses GITHUB_TOKEN with minimal permissions for artifact access

env:
  CARGO_TERM_COLOR: always
  DOCKER_BUILD_TEST_CORE_CLIENT: 1
  CARGO_INCREMENTAL: 0
  DOCKER_BUILDKIT: 1
  NPM_TAG: ""

# No top-level permissions needed - job-level permissions are more specific
permissions: {}

jobs:
  test-reporter:
    name: test-reporter/test-reporter
    permissions:
      checks: write # Required to create GitHub checks for test results
      packages: read # Required to read GitHub packages/container registry
      issues: write # Required to create comments on issues
      pull-requests: write # Required to create comments on pull requests
      actions: read # Required to read workflow run information and download artifacts
      contents: read # Required to checkout repository code
    runs-on: ubuntu-latest
    if: ${{ !cancelled() }}

    steps:
      - name: Checkout Project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: true
          token: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          persist-credentials: true

      - uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5
        with:
          path: /tmp/junit
          pattern: junit-test-report-*

      - name: Display structure of downloaded files
        continue-on-error: true
        run: |
          if find /tmp/junit -mindepth 1 -type f -print -quit 2>/dev/null | grep -q .; then
            echo "Files found in /tmp/junit"
            ls -R /tmp/junit/
            echo "TIMESTAMP=$(date +"%Y-%m-%d - %H:%M:%S")" >> "$GITHUB_ENV"
            echo "EXIT_CODE=0" >> "$GITHUB_ENV"
          else
            echo "No junit test files found in /tmp/junit"
            echo "EXIT_CODE=1" >> "$GITHUB_ENV"
            exit 1
          fi

      - name: Publish Test Report
        if: env.EXIT_CODE == 0
        uses: ctrf-io/github-test-reporter@646f98cfc16c6f7a0e1f6100cabe2deb95dd2eef # v1.0.22
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          report-path: "/tmp/junit/**/*.xml"
          title: "Consolidated Tests Results ${{ env.TIMESTAMP }}"
          overwrite-comment: true
          summary-report: false
          github-report: true
          pull-request-report: true
          pull-request: true
          test-report: true
          flaky-report: true
          collapse-large-reports: true
          report-order: "github-report,pull-request-report,test-report,flaky-report"
          integrations-config: |
            {
              "junit-to-ctrf": {
                "enabled": true,
                "action": "convert",
                "options": {
                  "output": "./ctrf-reports/ctrf-report.json",
                  "toolname": "junit-to-ctrf",
                  "useSuiteName": false,
                  "env": {
                    "appName": "kms"
                  }
                }
              }
            }
