on:
  pull_request:
    branches:
      - main

jobs:
  test-delete:
    runs-on: ubuntu-latest
    permissions:
      packages: write # Required to delete GitHub packages/container registry
      contents: read # Required to read repository code
    steps:
      - name: Clean up build
        env:
          GH_TOKEN: ${{ github.token }}
          IMAGE_TAG: "08b8c7f"
        run: |
          delete_package_versions_by_tag() {
            local package_name="$1"
            local tag="$2"

            # URL-encode package name (slashes -> %2F)
            local encoded_name
            encoded_name="$(jq -rn --arg v "$package_name" '$v|@uri')"

            local package_path="/orgs/zama-ai/packages/container/${encoded_name}"

            # Check package exists/readable
            if ! gh api -H "Accept: application/vnd.github+json" "$package_path" >/dev/null 2>&1; then
              echo "Package not readable/found: ${package_name}"
              return 0
            fi

            gh api --paginate -H "Accept: application/vnd.github+json" "${package_path}/versions?per_page=100" \
            | jq -r --arg tag "$tag" '
                if type=="array" then
                  .[] | select(any(.metadata.container.tags[]?; startswith($tag))) | .id
                else
                  empty
                end
              ' \
            | while read -r id; do
                [ -z "$id" ] && continue
                echo "Deleting ${package_name} version ${id}"
                gh api --method DELETE -H "Accept: application/vnd.github+json" "${package_path}/versions/${id}" \
                  || echo "Failed deleting ${package_name}:${id}"
              done
          }

          delete_package_versions_by_tag "kms/core-service-enclave" "08b8c7f"
          delete_package_versions_by_tag "kms/core-service" "08b8c7f"
          delete_package_versions_by_tag "kms/core-client" "08b8c7f"
