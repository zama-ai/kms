##############################################################################
# pr-preview workflow
##############################################################################
name: pr-preview-deploy

on:
  workflow_call:
    inputs:
      deployment_type:
        description: 'Deployment type (threshold, centralized, thresholdWithEnclave, centralizedWithEnclave)'
        required: true
        type: string
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      image_tag:
        description: 'Pre-built image tag to use'
        required: true
        type: string
      enclave_pcr0:
        description: 'Enclave PCR0 value'
        required: false
        type: string
      enclave_pcr1:
        description: 'Enclave PCR1 value'
        required: false
        type: string
      enclave_pcr2:
        description: 'Enclave PCR2 value'
        required: false
        type: string
    secrets:
      ZWS_BOT_TOKEN:
        required: true
      TS_OAUTH_CLIENT_ID:
        required: true
      TS_OAUTH_SECRET:
        required: true
      BLOCKCHAIN_ACTIONS_TOKEN:
        required: true

permissions: {}

jobs:
  ############################################################################
  # PR Preview Job
  # Now called from pr-ci.yml orchestrator with pre-built images
  ############################################################################
  pr-preview-deploy:
    name: pr-preview-deploy
    permissions:
      pull-requests: write # Required to update pull requests information
    runs-on: "runs-on=${{ github.run_id }}/runner=16cpu-linux-x64/spot=false"
    timeout-minutes: 1800

    # Environment variables used throughout the job
    env:
      NAMESPACE: 'kms-ci-${{ github.actor }}-${{ inputs.pr_number }}'
      TKMS_INFRA_CHART_VERSION: '0.3.2'
      SYNC_SECRETS_CHART_VERSION: '0.2.1'
      KMS_CORE_ENCLAVE_IMAGE_NAME: 'ghcr.io/zama-ai/kms/core-service-enclave'
      KMS_CORE_IMAGE_NAME: 'ghcr.io/zama-ai/kms/core-service'
      KMS_CORE_CLIENT_IMAGE_NAME: 'ghcr.io/zama-ai/kms/core-client'
      KMS_CORE_IMAGE_TAG: ${{ inputs.image_tag }}
      KMS_CORE_CLIENT_IMAGE_TAG: ${{ inputs.image_tag }}
      IMAGE_REPO: 'ghcr.io/zama-ai/kms'
      TLS: 'true'
      FHE_PARAMS: 'Test'
      DEPLOYMENT_TYPE: ${{ inputs.deployment_type }}
    steps:
      # ======================================================================
      # SET DEPLOYMENT PARAMETERS
      # Configure party count and thresholds based on deployment type
      # ======================================================================
      - name: Set Deployment Parameters
        run: |
          echo "Deployment type: ${DEPLOYMENT_TYPE}"
          if [[ "${DEPLOYMENT_TYPE}" == *"threshold"* ]]; then
            { echo "NB_KMS_PARTIES=4"; \
              echo "THRESHOLD_VALUE=1"; \
              echo "NUM_MAJORITY=2"; \
              echo "NUM_RECONSTRUCT=3"
            } >> "$GITHUB_ENV"
          elif [[ "${DEPLOYMENT_TYPE}" == *"centralized"* ]]; then
            { echo "NB_KMS_PARTIES=1"; \
              echo "NUM_MAJORITY=1"; \
              echo "NUM_RECONSTRUCT=1"
            } >> "$GITHUB_ENV"
          fi
          echo "Configured: ${DEPLOYMENT_TYPE} with NB_KMS_PARTIES parties"

      # ======================================================================
      # DOCKER BUILD STATUS HANDLING
      # ======================================================================
      - name: Login to zws GitHub Container Registry
        uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3.3.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.ZWS_BOT_TOKEN }}

      - name: Handle pre-built images and PCR values
        if: ${{ env.DEPLOYMENT_TYPE == 'thresholdWithEnclave' || env.DEPLOYMENT_TYPE == 'centralizedWithEnclave' }}
        env:
          JQ_VERSION: 1.8.1
          INPUT_PCR0: ${{ inputs.enclave_pcr0 }}
          INPUT_PCR1: ${{ inputs.enclave_pcr1 }}
          INPUT_PCR2: ${{ inputs.enclave_pcr2 }}
        run: |
          # shellcheck disable=SC2153
          ###################################################################
          # Use PCR values from inputs if provided, otherwise extract from image
          ###################################################################
          if [[ -n "${INPUT_PCR0}" ]]; then
            echo "Using PCR values from workflow inputs..."
            {
              echo "PCR0=${INPUT_PCR0}"
              echo "PCR1=${INPUT_PCR1}"
              echo "PCR2=${INPUT_PCR2}"
            } >> "$GITHUB_ENV"
          else
            echo "Extracting PCR measurements from enclave image..."
            # Download JQ.
            wget https://github.com/jqlang/jq/releases/download/jq-"${JQ_VERSION}"/jq-linux-amd64 -P /tmp
            # Install JQ.
            sudo mv /tmp/jq-linux-amd64 /usr/local/bin/jq
            sudo chmod +x /usr/local/bin/jq
            echo "JQ version: $(jq --version)"

            docker pull "${IMAGE_REPO}"/core-service-enclave:"${KMS_CORE_IMAGE_TAG}"
            PCR0=$(docker inspect "${IMAGE_REPO}"/core-service-enclave:"${KMS_CORE_IMAGE_TAG}" | jq -r '.[0].Config.Labels["zama.kms.eif_pcr0"]')
            PCR1=$(docker inspect "${IMAGE_REPO}"/core-service-enclave:"${KMS_CORE_IMAGE_TAG}" | jq -r '.[0].Config.Labels["zama.kms.eif_pcr1"]')
            PCR2=$(docker inspect "${IMAGE_REPO}"/core-service-enclave:"${KMS_CORE_IMAGE_TAG}" | jq -r '.[0].Config.Labels["zama.kms.eif_pcr2"]')
            {
              echo "PCR0=${PCR0}"
              echo "PCR1=${PCR1}"
              echo "PCR2=${PCR2}"
            } >> "$GITHUB_ENV"
          fi

      # ======================================================================
      # TOOLING SETUP
      # ======================================================================
      - name: Setup tailscale
        uses: tailscale/github-action@84a3f23bb4d843bcf4da6cf824ec1be473daf4de # v3.2.3
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:kms-ci

      - name: Setup helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
          export PATH=$PATH:/usr/local/bin

      - name: setup kubectl
        uses: azure/setup-kubectl@776406bce94f63e41d621b960d78ee25c8b76ede

      # ======================================================================
      - name: Get Rust version
        if: ${{ env.DEPLOYMENT_TYPE == 'thresholdWithEnclave' || env.DEPLOYMENT_TYPE == 'threshold' }}
        env:
          GH_WORKSPACE: ${{ github.workspace }}
        run: |
          version="$(grep 'channel' "$GH_WORKSPACE/rust-toolchain.toml" | awk -F' = ' '{print $2}' | tr -d '"')"
          echo "RUST_IMAGE_VERSION=$version" >> "$GITHUB_ENV"

      - name: Set up Rust
        if: ${{ env.DEPLOYMENT_TYPE == 'thresholdWithEnclave' || env.DEPLOYMENT_TYPE == 'threshold' }}
        uses: actions-rust-lang/setup-rust-toolchain@1780873c7b576612439a134613cc4cc74ce5538c # v1.15.2
        with:
          toolchain: ${{ env.RUST_IMAGE_VERSION }}
          components: rustfmt, clippy, llvm-tools-preview, llvm-tools
          cache: false

      - name: Install Protoc
        if: ${{ env.DEPLOYMENT_TYPE == 'thresholdWithEnclave' || env.DEPLOYMENT_TYPE == 'threshold' }}
        uses: arduino/setup-protoc@c65c819552d16ad3c9b72d9dfd5ba5237b9c906b # v3.0.0
        with:
          version: '26.x'
          repo-token: ${{ secrets.GITHUB_TOKEN }} # Add github token to avoid rate limit see docs https://github.com/arduino/setup-protoc

      # ======================================================================
      # KUBERNETES & HELM SETUP
      # ======================================================================
      - name: Setup kubeconfig
        run: |
          ###################################################################
          # Configure kubeconfig to connect to the Tailscale Kubernetes cluster
          ###################################################################
          echo "Configuring kubeconfig for Tailscale cluster..."
          tailscale configure kubeconfig tailscale-operator-zws-dev.diplodocus-boa.ts.net

      # ======================================================================
      # CHECK IF NAMESPACE EXISTS
      # ======================================================================
      - name: Check if namespace exists, delete and create
        run: |
          if kubectl get namespace "${NAMESPACE}" > /dev/null 2>&1; then
            echo "Namespace ${NAMESPACE} already exists"
            echo "Destroying namespace ${NAMESPACE}..."
            helm list -n "${NAMESPACE}" --short | xargs -L1 helm uninstall -n "${NAMESPACE}"
            kubectl delete namespace "${NAMESPACE}" --grace-period=1 --timeout=5s --wait=false
            echo "Waiting for namespace to be destroyed..."
            kubectl wait --for=delete namespace/"${NAMESPACE}" --timeout=120s
            echo "Namespace ${NAMESPACE} destroyed"
            kubectl get namespace
            kubectl create namespace "${NAMESPACE}"
          else
            echo "Namespace ${NAMESPACE} does not exist"
            kubectl create namespace "${NAMESPACE}"
          fi

      - name: Checkout Project KMS
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          token: ${{ secrets.BLOCKCHAIN_ACTIONS_TOKEN }}
          persist-credentials: false


      - name: Unified Deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # For registry creds if needed
        run: |
          chmod +x ci/scripts/deploy.sh
          ./ci/scripts/deploy.sh \
            --target aws-ci \
            --namespace "${NAMESPACE}" \
            --deployment-type "${DEPLOYMENT_TYPE}" \
            --tag "${KMS_CORE_IMAGE_TAG}" \
            --num-parties "${NB_KMS_PARTIES}"

      - name: Generate PR Comment Body
        if: success()
        run: |
          if [[ "${DEPLOYMENT_TYPE}" == *"threshold"* ]]; then
            TEST_NAME="kubernetes_test_threshold"
            CONFIG_FILE="client_local_kind_threshold.toml"
            # Using a temporary file to construct multiline string for port-forward
            cat <<EOF > port_forward_cmd.txt
          kubectl port-forward svc/kms-core-1-core-1 -n ${NAMESPACE} 50100:50100 & \\
          kubectl port-forward svc/kms-core-2-core-2 -n ${NAMESPACE} 50200:50100 & \\
          kubectl port-forward svc/kms-core-3-core-3 -n ${NAMESPACE} 50300:50100 & \\
          kubectl port-forward svc/kms-core-4-core-4 -n ${NAMESPACE} 50400:50100 &
          EOF
            PORT_FORWARD_CMD=$(cat port_forward_cmd.txt)
            # Use regex to replace addresses: kms-core-X -> localhost:50X00 (e.g. party 1 -> 50100, party 2 -> 50200)
            COPY_COMMAND="kubectl cp $NAMESPACE/kms-core-client-0:/app/kms-core-client/config.toml ./core-client/config/client_local_kind_threshold.toml && \\
              sed -i '' -E 's|address = \"(http://)?kms-core-([0-9]+)-[^:]+:50100\"|address = \"http://localhost:50\200\"|' ./core-client/config/client_local_kind_threshold.toml"
          else
            TEST_NAME="kubernetes_test_centralized"
            CONFIG_FILE="client_local_kind_centralized.toml"
            # Use regex to replace address: kms-core-core -> localhost:50100
            COPY_COMMAND="kubectl cp $NAMESPACE/kms-core-client-0:/app/kms-core-client/config.toml ./core-client/config/client_local_kind_centralized.toml && \\
              sed -i '' -E 's|address = \"(http://)?kms-core-core:50100\"|address = \"http://localhost:50100\"|' ./core-client/config/client_local_kind_centralized.toml"
            PORT_FORWARD_CMD="kubectl port-forward svc/kms-core-core -n $NAMESPACE 50100:50100"
          fi

          # Generate the final comment body
          cat <<EOF > pr_comment.md
          **:rocket: Preview deployment is deployed in "${DEPLOYMENT_TYPE}" mode**

          You can now port-forward the kms-core to run your tests locally against the preview deployment.

          Connect to the Tailscale cluster zws-dev:
          \`\`\`bash
          tailscale configure kubeconfig tailscale-operator-zws-dev.diplodocus-boa.ts.net
          \`\`\`

          Port-forward the kms-core services to run your tests locally:
          \`\`\`bash
          ${PORT_FORWARD_CMD}
          \`\`\`

          Copy config.toml from core-client to ./core-client/config/${CONFIG_FILE}
          :warning: Make sure to not push this config.toml file to the repository!
          \`\`\`bash
          ${COPY_COMMAND}
          \`\`\`

           :rocket: And launch your tests:
          \`\`\`bash
          cargo nextest run --test ${TEST_NAME} --profile ci --no-fail-fast
          \`\`\`

          You can connect to the core-client with:
          \`\`\`bash
          kubectl exec kms-core-client-0 -n ${NAMESPACE} -it -- /bin/bash
          \`\`\`

          Close your port-forwarding with:
          \`\`\`bash
          pgrep -f "kubectl port-forward" | xargs -n 1 kill
          \`\`\`
          EOF

      - name: Update pull request
        if: success()
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9 # v5.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          reactions: 'rocket'
          body-path: pr_comment.md